var app = angular.module('meantodo', []);

app.controller('masterController', masterController);

masterController.$inject = ['$scope']
function masterController(sc) {
    var vm = this;
    sc.master.link = "";
    vm.login = true;
    vm.main = false;
}
angular
    .module('meantodo')
    .controller('loginController', loginController);

loginController.$inject = ['$scope', 'userService']
function loginController(sc, userService) {
    var vm = this;
    vm.user = {};
    vm.response = {};
    vm.login = login;
    getUser();

    function login() {
        userService.login(vm.user.Email, vm.user.Password, handleLogin);

        function handleLogin(response) {
        
            if (response.status == 200) {
                // hide login and pass user info to main controller
                console.log(response);
                sc.master.user = response.data;
                vm.user = response.data;
                getUser();
                //sc.master.login = false;
            }
            else {
                // show error message
                vm.response = response;
            }
        }
    }

    function getUser() {
        userService.getUser(vm.user.Uid, handleGetUser); 

        function handleGetUser(response) {
            console.log(response);
            if (!response) {
                return;
            }
            if (response.status == 200) {
                console.log('SUCCESS ' + response.statusText);
            }
            else {
                console.log('FAIL ' + response.status + ': ' + response.statusText);
            }
        }
    }

    
}
angular
    .module('meantodo')
    .factory('userService', userService);

userService.$inject = ['$http']
function userService(http) {
    var service = {
        login: login,
        getUser: getUser
    }

    return service;

    function login(email, password, done) {
        http({
            method: 'POST',
            url: 'http://localhost:3000/login',
            data: {
                Email: email,
                Password: password
            }
        }).then(function success(data, status, headers, config) {
            console.log('data: ' + data);
            console.log('status: ' + status);
            console.log('headers: ' + headers);
            console.log('config: ' + config);
            done(data);
        }, function error(error) {
            done(error);
        });
    }

    function getUser(userId, done) {
        if (!userId) {
            done(null);
            return;
        }

        http({
            method: 'GET',
            url: 'http://localhost:3000/api/users/' + userId
        }).then(function success(response) {
            done(response);
        }, function error(error) {
            done(error);
        });
    }
}
angular
    .module('meantodo')
    .controller('mainController', mainController);

mainController.$inject = ['$scope'];
function mainController(sc) {
    var vm = this;
    vm.output = {};
    vm.user = sc.master.user;
}
